<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>UI réactive dans Unity</title>

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/white.css">
    <link rel="stylesheet" href="dist/theme/fonts/plus-jakarta-sans/jakarta.css">
    <link rel="stylesheet" href="dist/theme/fonts/PPMonumentExtended-Bold/PPMonumentExtended-Bold.css">

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/zenburn.css">

    <style>
        * {
            --r-main-font: Jakarta, sans-serif;
        }

        * h1 {
            --r-heading-font: PPMonumentExtended, sans-serif;
            --r-heading1-size: 1.6em;
        }

        * h2, * h3, * h4 {
            --r-heading-font: Jakarta, sans-serif;
            --r-heading2-size: 4.5rem;
            --r-heading3-size: 2.5rem;
        }

        section > section.past:first-child {
            display: block !important;
            opacity: 1 !important;
            transform: translate(0, 0) !important;
            top: 0px !important;
        }

        section > section.past:first-child * {
            font-size: 36px !important;
            margin-top: 10px;
        }

        .reveal section img {
            border: none;
            outline: 4px solid black;
        }

        .reveal section img.no-border {
            border: none;
            outline: 0;
        }

        .reveal pre code {
            max-height: 460px;
        }

        .reveal pre {
            width: 100%;
        }

        small, .small {
            font-size: 36px !important;
        }

        .smaller {
            font-size: 30px !important;
        }

        pre.small {
            font-size: 24px !important;
        }

        pre.smaller {
            font-size: 20px !important;
        }
    </style>
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section>
            <h1>UI réactive dans Unity</h1>
            <em>Pourquoi et comment brancher sa UI sur un state observable ?</em>
        </section>
        <section><h2>Samuel BOUCHET</h2>
            <div>Développeur Unity chez Lonestone</div>

            <img src="assets/photo.png" style="width: 200px;height: auto;"/>

            <div><a href="https://twitter.com/Lythom">@Lythom</a></div>

            <aside class="notes">
                <li>formation Ingénieur logiciel</li>
                <li>Société de service / édition logicielle / Web / JavaScript / 5 ans de Jeux Vidéo (34 ans)</li>
                <li>Développeur JS</li>
            </aside>
        </section>
        <!-- Le plan -->
        <section>
            <section>
                <h2>Le plan</h2>
                <ol>
                    <li>Histoire</li>
                    <li>Architecture général et exemples</li>
                    <li>Intérêts et limites</li>
                </ol>
                <div><img src="assets/giphy_lookup.webp" alt="" height="160"></div>
                <aside class="notes">
                    <li>Comment est née l'idée ? De quoi est-ce qu'il s'agit ?</li>
                    <li>=> Gestionnaire de l'état de l'application et branchement de la UI</li>
                    <li>Pourquoi ou pourquoi pas ?</li>
                    <li>Structure: Comment ?</li>
                    <li>Code review: implémentation sur mesure pour StarTeam</li>
                </aside>
            </section>
        </section>
        <!-- La réactivité -->
        <section>
            <section>
                <h2>L'histoire (1/3)</h2>
            </section>
            <section>
                <h3>Le web en 2013</h3>
                <ul>
                    <li class="small">Les webmestres préfixent leur recherche par <code>JQuery</code></li>
                    <li class="small">La boucle classique est <img src="assets/flow_http_server.png"
                                                                   alt="Requête Http → Contrôleur → Donnée → Vue → Requête Http"/>
                    </li>
                </ul>
            </section>
            <section>
                <h3>Apparition de React</h3>
                <ul>
                    <li class="small">React est une bibliothèque de rendu</li>
                    <li class="small">La promesse: <code>Vue=fn(Donnée)</code>
                        <ul>
                            <li>
                                → Paradigme déclaratif
                            </li>
                        </ul>
                    </li>
                    <li class="small">Collocalisation de la vue et du comportement: Programmation par composant</li>
                </ul>
            </section>
            <section>
                <h3>Flux & Redux (2015)</h3>
                <div>one-way data flow structure</div>
                <figure>
                    <img src="assets/flow_flux.png" alt="Action → Dispatcher → Store → View → Action"/>
                    <figcaption style="font-size: 16px;margin:0;padding:0;height:0">Source:
                        https://facebook.github.io/flux/docs/in-depth-overview/
                    </figcaption>
                </figure>
                <aside class="notes">
                    <li>Structure similaire au web client/server mais local</li>
                    <li>État applicatif centralisé: une seule source de vérité monolithique, minimale mais suffisante
                        (aucune
                        donnée calculée)
                    </li>
                    <li>Les vues s'abonnent aux données et se mettent à jour en réaction aux changement de données</li>
                    <li>La forme de la donnée est figée (~base de donnée)</li>
                </aside>
            </section>
            <section>
                <h3>On s'inspire et on garde:</h3>
                <ol>
                    <li>Circulation des données en sens unique</li>
                    <li>Organisation en composants autonomes</li>
                    <li>Le composant s'abonne aux fragments de données dont il a besoin</li>
                    <li>Centralisation de l'état applicatif, minimal mais suffisant</li>
                    <li>Utilisation de sélecteurs pour accéder aux données calculées</li>
                </ol>
                <aside class="notes">
                    <li>1. Une action ne modifie pas la vue, ni la donnée directement</li>
                    <li>2. On regroupe vue et comportements. !Cette notion de composant est différente de celle de
                        Unity. Ici composant ~= prefab.
                    </li>
                </aside>
            </section>
            <section>
                <h3>Démo</h3>
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
                <!--              <div>TODO une implémentation Unity minimaliste pour illustrer</div>-->
            </section>
        </section>
        <section>
            <section>
                <h2 style="white-space: nowrap">Architecture Générale (2/3)</h2>
            </section>
            <section>
                <h3>StarTeam</h3>
                <img style="float: left" src="assets/mysticwell.png" width="540"/>
                <div class="smaller" style="float:right;width:40%;margin-top: 70px;">
                    <ul>
                        <li style="padding-top: 15px;">Jeu d'aventure coopératif asynchrone</li>
                        <li style="padding-top: 15px;">3 à 5 joueurs doivent remplir leur objectif en un nombre de jours
                            limité
                        </li>
                    </ul>
                </div>
            </section>
            <section>
                <h3 style="margin-bottom: 10px">StarTeam</h3>
                <div class="smaller" style="float:left;width:35%;text-align: left;margin-top: 170px;">
                    Les joueurs explorent une carte et actionnent des points d'intérêts pour
                    déclencher des aventures
                </div>
                <img style="float: right;margin:0 0 0 30px;outline:0" src="assets/starteam_aventure.png" width="290"/>
                <img style="float: right;margin:0 0 0 10px;outline:0" src="assets/starteam_map.png" width="290"/>
                <div style="float:right;font-size: 14px;line-height: 0.5;text-align: right;margin:8px 0 0 0;padding:0">En développement: images non
                    représentatives de la qualité finale
                </div>
            </section>

            <section>
                <h3>StarTeam</h3>
                <img style="float: left" src="assets/starteam_village.png" width="540"/>
                <div class="smaller" style="float:right;width:41%;margin-top: 70px;">
                    <ul>
                        <li style="padding-top: 15px;">Jeu multijoueur en réseau</li>
                        <li style="padding-top: 15px;">Projet séparé en 3 :<ul>
                            <li>Serveur (réseau et bdd)</li>
                            <li>Client (rendu)</li>
                            <li>Bibliothèque partagée (logique gameplay)</li>
                        </ul></li>
                    </ul>
                </div>
            </section>
            <section>
                État de l'application (state) découpé en 4 :
                <ol>
                    <li>Données statiques</li>
                    <li>Règles de jeu</li>
                    <li>Données de partie (GameState)</li>
                    <li>Données locales (LocalState)</li>
                </ol>
            </section>
            <section>
                <h3>Données statiques</h3>
                <em class="smaller" style="margin: -15px 0 15px 0;display:block">dans StarTeam: GameElements</em>
                <ul>
                    <li>Context: client + serveur</li>
                    <li>Cycle de modification : version</li>
                    <li>Initialisées au démarrage de l'application</li>
                    <li>Immuables, accès en lecture seul global et static</li>
                </ul>
                <aside class="notes">
                    <li>GameElements = éléments du jeu, contenu du jeu. Ex: objets, personnages, roles</li>
                    <li>Création d'une BDD statique: intégrée dans Unity via Odin Inspector et sérialisée avec
                        MessagePack
                    </li>
                </aside>
            </section>
            <section>
                <h3>Règles du jeu</h3>
                <em class="smaller" style="margin: -15px 0 15px 0;display:block">dans StarTeam: Ruleset</em>
                <ul>
                    <li>Context: client + serveur</li>
                    <li>Cycle de modification : une partie</li>
                    <li>Transmises avec la partie (1 fois)</li>
                    <li>Immuables, accès en lecture seule</li>
                </ul>
            </section>
            <section>
                <h3>Données de jeu</h3>
                <em class="smaller" style="margin: -15px 0 15px 0;display:block">dans StarTeam: GameState</em>
                <ul>
                    <li>Context: client + serveur</li>
                    <li>Cycle de modification : une action (GameEvent)</li>
                    <li>Transmises 1 fois lors de la connexion</li>
                    <li>Mise à jour synchronisée serveur / clients via actions</li>
                </ul>
            </section>
            <section>
                <h3>Données locales</h3>
                <em class="smaller" style="margin: -15px 0 15px 0;display:block">dans StarTeam: LocalState</em>
                <ul>
                    <li>Context: client</li>
                    <li>Cycle de modification : à volonté</li>
                    <li>Une instance par client, jamais transmise</li>
                </ul>
            </section>
            <section>
                <h3>Outils de lecture du state</h3>
                <ul class="small">
                    <li>Les accesseurs pour faciliter l'utilisation et découpler l'utilisation du state de sa forme</li>
                    <li>Des sélecteurs pour mettre en cache des données calculées et les exposer réactivement</li>
                    <li>Un composant surchargeable qui fournit les accès au contexte de l'application (ConnectedMonoBehaviour)</li>
                </ul>
            </section>
            <section>
                <h3>Code review</h3>
                <code>RollDiceGameEvent</code>
                <aside class="notes">
                    <li>AssertApplicationConditions pour debug et documentation (pour implémentation du client)</li>
                    <li>DoApply = seul endroit où on a le droit de modifier le GameState</li>
                    <li>GameManager.HandleNetMessage</li>
                    <li>StarTeamServer.HandleMessageAsync</li>
                    <li>client → server → client</li>
                    <li>Optimistic update possible</li>
                </aside>
            </section>
            <section>
                <h3>Code review</h3>
                <code>ConnectedMonoBehaviour</code>
                <aside class="notes">
                    <li>Gère le cycle de vie</li>
                    <li>ResetToken invalidé lors du Destroy</li>
                    <li>ResetToken invalidé puis réinitialisé lors d'un enable ou d'une injection de state</li>
                    <li>Expose le GameManager (state, SocketManager et SideEffectManager)</li>
                </aside>
            </section>
            <section>
                <h3>Code review</h3>
                <code>Reactive&lt;T&gt;</code>
                <aside class="notes">
                    <li>Encapsulation de AsyncReactiveProperty pour pouvoir sérializer + Odin inspecteur https://github.com/Cysharp/UniTask</li>
                    <li>Utilisation: reactiveVar.ForEachAsync(value => {/*do something*/}, CancellationToken)</li>
                </aside>
            </section>
            <section>
                <h3>Code review</h3>
                <code>DiceCharacterDisplay</code>
                <aside class="notes">
                    <li>Selecteur local</li>
                    <li>Subscribe GameState</li>
                    <li>Subscribe LocalState</li>
                    <li>OnClick Update direct LocalState</li>
                    <li>SubscribeSideEffect react to events</li>
                </aside>
            </section>
        </section>

        <section>
            <section>
                <h2 style="white-space: nowrap">Intérêts et limites (3/3)</h2>
            </section>

            <section>
                <h3>Limite 1 : Lourdeur et rigueur</h3>
                <ul>
                    <li class="small">Les changements de states doivent être spécifiés et normalisés
                        <ul class="smaller">
                            <li>Du boilerplate</li>
                        </ul>
                    </li>
                    <li class="small">Le state devra suivre une structure précise et cohérente
                        <ul class="smaller">
                            <li>Soit en contrôlant avec le l'outillage</li>
                            <li>Soit en faisant preuve de rigueur (code reviews et bonne compréhension des mécaniques
                                par tous les membres de l'équipe)
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>
            <section>
                <h3>Limite 2 : Nécessite une compréhension globale du système</h3>
                <ul class="small">
                    <li>Une action = une transaction. Ex: Une action pour changer les point de vie ? NON
                        <ul class="smaller">
                            <li>→ Une action "utilisation d'un objet"</li>
                            <li>→ Une action "échec d'un jet de risque"</li>
                            <li>→ Etc.</li>
                        </ul>
                    </li>
                    <li>Source de vérité unique centralisée (Single source of truth)
                        <ul class="smaller">
                            <li>Non redondance</li>
                            <li>Externalisation des données calculées</li>
                        </ul>
                    </li>
                    <li>State en lecture seule</li>
                </ul>
                <aside class="notes">
                    Habitudes de programmations peu habituelles pour les devs et il s'y conformer n'est pas évident
                </aside>
            </section>
            <section>
                <h3>Limite 3 : Animations et transitions</h3>
                <ul class="small">
                    <li>Les états n'indiquent que la situation finale</li>
                    <li>Chaque composant est autonome pour passer de son état actuel vers son état cible, ce qui rend
                        l'orchestration difficile.
                    </li>
                </ul>
            </section>
            <section>
                <h3>Limite 4 : peu utile si pas de cache</h3>
                <ul class="small">
                    <li>Les composants qui se mettent à jour chaque update pourront lire la valeur depuis le state mais bénéficient peu de la réactivité.</li>
                    <li>Utile pour la UI et les invalidation de cache</li>
                    <li>Peu utile pour les objets 3D ou 2D de la scène</li>
                </ul>
            </section>
            <section>
                <h3>Raison 1 : Prédictibilité</h3>
                <blockquote class="smaller">Les modèles et les outils fournis par Redux permettent de comprendre plus
                    facilement <b>quand, où, pourquoi et comment l'état de votre application est mis à jour</b>, et <b>comment
                        la logique de votre application se comportera</b> lorsque ces changements se produiront.
                </blockquote>
                <div style="white-space: nowrap; font-size: 20px">Source:
                    https://redux.js.org/tutorials/essentials/part-1-overview-concepts
                </div>
            </section>

            <section>
                <h3>Raison 2 : Transactionnalité</h3>
                <ul class="small">
                    <li>En modifiant le state action après action, on garantit son intégrité.</li>
                    <li>Mise en réseau: les changements de states sont spécifiés et normalisés, ce qui facilite la
                        transmission de messages de changement d'état
                    </li>
                </ul>
            </section>

            <section>
                <h3>Raison 3 : Injection d'état</h3>
                <ul>
                    <li>Phase de dev:
                        <ul class="small">
                            <li>mettre le jeu dans l'état où la fonctionnalité est testable</li>
                        </ul>
                    </li>
                    <li>Phase de debug:
                        <ul class="small">
                            <li>attacher une image de l'état du jeu lors d'une remontée de bug</li>
                            <li>mettre le jeu dans l'état où le bug est reproductible</li>
                        </ul>
                    </li>
                    <li>Phase de runtime:
                        <ul class="small">
                            <li>initialiser une sauvegarde de n'importe quel état</li>
                        </ul>
                    </li>
                </ul>
                <aside class="notes">
                    <li>Pourquoi vouloir ce système pour nos jeux ?</li>
                    <li>Si un joueur remonte un bug à la 25eme étape qui n'est affichée que les soirs de pleine lune,
                        dévélopper la feature et reproduire peut être fastidieux
                    </li>
                    <li></li>
                </aside>
            </section>

            <section>
                <h3>Raison 4 : Testabilité</h3>
                <ul class="smaller">
                    <li>Tests utiles et faciles à écrire via snapshot des différentiels d'état avant / après application d'une action</li>
                    <li>State et logique métier isolé et découplé facilite et accélère les tests.</li>
                </ul>
            </section>

            <section>
                <h3>Raison 5 : Découpler données et vue</h3>
                <ul class="small">
                    <li>Souvent dans Unity, les objets de la scène sont source de vérité mais cette donnée n'est pas
                        accessible facilement au serveur et aux autres joueurs
                    </li>
                </ul>
                <div class="small">→ En déportant la source de vérité dans un state dédié, et en construisant les
                    composants comme des "images réactives" de cet état on facilite le partage et les tests.
                </div>
            </section>
        </section>

        <section>
            <section>
                <h2>Conclusion</h2>
            </section>
            <section>
                <ul>
                    <li>Centraliser le state sous forme minimale pour le rendre testable, maintenable et performant</li>
                    <li>Faire circuler les données en sens unique : changements via des actions pour rendre les comportements précictibles et la mise en réseau aisée</li>
                    <li>Rendre le state observable pour avoir des composants autonomes et réactifs</li>
                </ul>
                <aside class="notes">
                    <li>Ouverture: cette présentation = vue synthétique qui masque un peu de complexité.</li>
                    <li>Pour le moment cette structure tient ses promesses vis à vis des enjeux techniques de StarTeam.</li>
                </aside>
            </section>
        </section>

        <!-- Le monsieur qui parle -->
        <section>
            <section><h2>Samuel BOUCHET</h2></section>
            <section>
                <div>Développeur Unity chez Lonestone</div>

                <img src="assets/photo.png" style="width: 200px;height: auto;"/>

                <div><a href="https://twitter.com/Lythom">@Lythom</a></div>

                <aside class="notes">
                    <li>formation Ingénieur logiciel</li>
                    <li>Société de service / édition logicielle / Web / JavaScript / 5 ans de Jeux Vidéo (34 ans)</li>
                    <li>Développeur JS</li>
                </aside>
            </section>
            <section>
                <h3>City Invaders</h3>
                <span>
                <img src="assets/CI_Screenshot_02.jpg" style="margin: 0" width="460"/>
                <img src="assets/CI_Screenshot_05.jpg" style="margin: 0" width="460"/>
                <img src="assets/CI_Screenshot_06.jpg" style="margin: 0" width="460"/>
                <img src="assets/logo-lonestone-studio.png" style="margin: 40px 0 0 0;vertical-align: top; outline: 0"
                     width="460"/>
                </span>
                <aside class="notes">
                    <li>Chez Lonestone depuis 2 ans</li>
                </aside>
            </section>
            <section style="background: black;color: white;">
                <h3 style="color: white;"><a href="https://a-time-paradox.com/"><img src="assets/lythom_atimeparado.jpg"
                                                                                     alt="A Time Paradox" height="600"/></a>
                </h3>
                <aside class="notes">
                    <li>A Time Paradox</li>
                    <li>Solo + freelances - Sorti en 2019 Android + PC</li>
                    <li>Développé avec Unity</li>
                </aside>
            </section>
            <section>
                <h3>Mod minecraft - Capsule</h3>
                <img src="assets/lythom_capsule.gif" style="margin: 0"/>
                <div><img src="assets/capsule_dls.png" class="no-border" style="margin: 0"/></div>
                <a href="https://minecraft.curseforge.com/projects/capsule">https://minecraft.curseforge.com/projects/capsule</a>
            </section>
        </section>
    </div>
</div>

<script src="dist/reveal.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/highlight/highlight.js"></script>
<script>
    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
        hash: true,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
    });
</script>
</body>
</html>
